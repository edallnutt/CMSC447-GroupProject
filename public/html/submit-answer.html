<div class="container text-center">
    <h2 id='tblTitle'>
        <span>Click a Row to Submit an Answer:</span>
        <span>
            <input type="text" id="tableSearch" onkeyup="searchTable('tableSearch','tbl',0)" placeholder="Search for alias...">
        </span>
    </h2></br></br>
    <table id="tbl">
        <tr>
            <th onclick="if(show>=0)tbl.deleteRow(show);show=-1;sortTable(0,'tbl')">Alias</th>
            <th onclick="if(show>=0)tbl.deleteRow(show);show=-1;sortTable(1,'tbl')">Part of Number</th>
            <th onclick="if(show>=0)tbl.deleteRow(show);show=-1;sortTable(2,'tbl')">Number Length</th>
            <th onclick="if(show>=0)tbl.deleteRow(show);show=-1;sortTable(3,'tbl')">Factorized Count</th>
            <th onclick="if(show>=0)tbl.deleteRow(show);show=-1;sortTable(4,'tbl')">First Factorized Time</th>
        </tr>
    </table>
</div>

<script>
var tbl  = document.getElementById('tbl')       // Submission table
var email_num = '{{student_num}}';                // Number associated with user
var dat  = JSON.parse('{{course.JSON}}')        // Project data

/*      Insert student data into table      */
var show = -1
for(var i = 0; i < dat.length; i++){
    var row                     = tbl.insertRow(-1)
    row.onclick                 = function(r,j){return function(){expand(r,j+2)}}(row,i)
    row.insertCell(0).innerHTML = dat[i][0].alias
    row.insertCell(1).innerHTML = dat[i][0].num_submit
    row.insertCell(2).innerHTML = dat[i][0].num_length
    row.insertCell(3).innerHTML = dat[i][0].factor_count
    row.insertCell(4).innerHTML = dat[i][0].first_factor_time

    // Highlight numbers you factored
    for(var key in dat[i][0].factorized_by_me){
        if(email_num === key && dat[i][0].factorized_by_me[key] === true)
            row.className = "ok"
	break
    }
}

function expand(row,i){
    if(show>=0)
        tbl.deleteRow(show)
    var col       = tbl.insertRow(row.rowIndex+1).insertCell(0)
    col.colSpan   = 5
    col.innerHTML = "\
	<form action='submit-answer' onsubmit='return verify()' method='post'>\
	<input name='submit_answer' placeholder='"+(row.className === "ok"?"You have already submitted. Submit again if you want":"Enter 2 or more factors separated by a space and hit enter to submit")+"'></input>\
	<textarea name='user_email' style='display:none'></textarea>\
	<textarea name='user_token' style='display:none'></textarea> \
	<button>submit</button>\
	</form>"
    show          = row.rowIndex+1
}

function verify(){
    var box = document.getElementsByTagName('input')[1]
    if(RegExp("^[0-9]+ [0-9]+$").test(box.value)){
	document.getElementsByName('user_email')[0].value = getUserEmail()
	document.getElementsByName('user_token')[0].value = getUserToken()
	document.getElementsByTagName('form')[0].submit()
        box.value       = ''
	box.placeholder = 'Answer submitted. Waiting for server response...'
    }else{
        box.value       = ''
	box.placeholder = 'Invalid format. Enter 2 or more factors separated by a space and hit enter to submit'
	return false
    }
}
</script>
