
<div class="sub-ans-table"> <!-- container text-center  -->
    <h2 id='tblTitle'>
        <span>Click a Row to Submit an Answer:</span>
    </h2></br>
    <table id="tbl" align="center">
        <thead>
            <tr>
                <th>Alias</th>
                <th>Last 10 Digits</th>
                <th>Bit Length</th>
                <th>Prime Number</th>
                <th>Factorized Count</th>
                <th>First Factorized Time</th>
            </tr>
        </thead>
        <tfoot></tfoot>
        <tbody></tbody>
    </table>
    <h2 id="alias"></h2>
    <h3 id="check">{{check}}</h3>
</div>

<script>

    var tbl   = document.getElementById('tbl').getElementsByTagName('tbody')[0];       // Submission table
    var email_num = '{{student_num}}';                // Number associated with user
    var data   = JSON.parse('{{course.JSON}}');        // Project data
    var alias = data[email_num];

    if(alias)
        alias = alias[0].alias;
    else
        alias = 'unknown';
    document.getElementById('alias').innerHTML = "Your alias is: " + alias;
    /*      Insert student data into table      */

    for(var i = 0; i < data.length; i++){
        if (data[i][0].type === 'student') {
            var row = tbl.insertRow(0);
            row.onclick = function (r, j) {
                return function () {
                    expand(r, j + 2);
                }
            }(row, i);
            row.insertCell(0).innerHTML = data[i][0].alias;
            row.insertCell(1).innerHTML = data[i][0].num_submit.slice(-10);
            row.insertCell(2).innerHTML = data[i][0].num_length;
            row.insertCell(3).innerHTML = data[i][0].num_prime;
            row.insertCell(4).innerHTML = data[i][0].factor_count;
            row.insertCell(5).innerHTML = data[i][0].first_factor_time;
            row.setAttribute("expanded", "false");
            // Highlight numbers you factored
            for (var key in data[email_num][0].factorized_by_me) {
                /*if(key.includes("_")){
                    for(var numKey in data[i][0])
                }*/
                console.log(key);
                if (data[i][0].alias === key && data[email_num][0].factorized_by_me[key] === true) {
                    row.className = "ok"
                    break
                }
            }
        }
        else {
            for (var sub in data[i][0].nums) {
                var row = tbl.insertRow(0);
                row.onclick = function (r, j) {
                    return function () {
                        expand(r, j + 2);
                    }
                }(row, i);

                row.insertCell(0).innerHTML = data[i][0].nums[sub].alias;
                row.insertCell(1).innerHTML = data[i][0].nums[sub].num_submit.slice(-10);
                row.insertCell(2).innerHTML = data[i][0].nums[sub].num_length;
                row.insertCell(3).innerHTML = data[i][0].nums[sub].num_prime;
                row.insertCell(4).innerHTML = data[i][0].nums[sub].factor_count;
                row.insertCell(5).innerHTML = data[i][0].nums[sub].first_factor_time;
                row.setAttribute("expanded", "false");
                // Highlight numbers you factored
                for (var key in data[email_num][0].factorized_by_me){
                    if (data[i][0].nums[sub].alias === key && data[email_num][0].factorized_by_me[key] === true) {
                        row.className = "ok"
                        break
                    }
                }
                /*for (var key in data[i][0].nums[sub].factorized_by_me) {
                    if (data[i][0].nums[sub].alias == key && data[i][0].nums[sub].factorized_by_me[key] == true) {
                        row.className = "ok"
                        break
                    }
                }*/

            }
        }
    }

    $('#tbl').DataTable();

    var show = -1;
    function expand(row,i){
        if(show>=0) {
            tbl.deleteRow(show);
            show = -1;
            row.setAttribute("expanded", "false");
        } else {

            if (row.getAttribute("expanded") == "false") {
                row.setAttribute("expanded", "true");
                var col = tbl.insertRow(row.rowIndex).insertCell(0)
                col.colSpan = 6
                col.innerHTML = "\
        <form action='submit-answer' onsubmit='return verify()' method='post'>\
        <input name='submit_answer' placeholder='" + (row.className === "ok" ? "You have already submitted. Submit again if you want" : "Enter 2 or more factors separated by a space and hit enter to submit") + "'></input>\
        <textarea name='user_email' style='display:none'></textarea>\
        <textarea name='user_token' style='display:none'></textarea> \
        <textarea name='num_to_answer'  style='display:none'></textarea> \
        <textarea name='num_to_answer_alias'  style='display:none'></textarea> \
        <button>submit</button>\
        </form>"
                show = row.rowIndex;
            }
        }
    }

    function verify(){
        var box = document.getElementsByTagName('input')[1]
        if(RegExp("^[0-9]+ [0-9]+$").test(box.value)){
            document.getElementsByName('user_email')[0].value = getUserEmail()
            document.getElementsByName('user_token')[0].value = getUserToken()
            document.getElementsByName('num_to_answer_alias') [0].value = tbl.rows[show-1].cells[0].innerHTML
            document.getElementsByName('num_to_answer') [0].value = tbl.rows[show-1].cells[1].innerHTML
            return true
        }else{
            box.value       = ''
            box.placeholder = 'Invalid format. Enter 2 or more factors separated by a space and hit enter to submit'
            return false
        }
    }
</script>
